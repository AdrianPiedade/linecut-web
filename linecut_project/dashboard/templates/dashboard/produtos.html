{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}LineCut - Produtos{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{% static 'dashboard/css/produtos.css' %}">
{% endblock %}

{% block content %}
    <header class="cabecalho-produtos">
        <div class="titulos">
            <h1 class="titulo-ativo">Produtos</h1>
            <h1 class="titulo-inativo btn-cadastrar-texto" onclick="abrirModal()">Cadastrar</h1>
        </div>
    </header>

    <div class="filtros">
        <div class="filtro-group">
            <label>Buscar produto</label>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Digite o nome do produto...">
            </div>
        </div>
        <div class="filtro-group">
            <label>Categoria</label>
            <select id="categoria-filter">
                <option value="">Todas as categorias</option>
                {% if categorias %}
                    {% for categoria in categorias %}
                        <option value="{{ categoria }}">{{ categoria }}</option>
                    {% endfor %}
                {% else %}
                    <option value="" disabled>Erro ao carregar</option>
                {% endif %}
            </select>
        </div>
        <div class="filtro-group">
            <label>Status</label>
            <select id="status-filter">
                <option value="">Todos</option>
                <option value="disponivel">Disponível</option>
                <option value="indisponivel">Indisponível</option>
            </select>
        </div>
    </div>

    <div class="tabela-container">
        <div class="cabecalho-tabela">
            <span class="col-id">ID</span>
            <span class="col-nome">Produto</span>
            <span class="col-descricao">Descrição</span>
            <span class="col-preco">Preço</span>
            <span class="col-quantidade">Qtd.</span>
            <span class="col-status">Status</span>
            <span class="col-acoes">Ações</span>
        </div>

        <div class="corpo-tabela" id="produtos-lista">
            {% for product in products %}
            <div class="linha-produto"
                data-product-id="{{ product.id|default:'N/A' }}"
                data-category="{{ product.category }}"
                data-status="{% if product.is_available %}disponivel{% else %}indisponivel{% endif %}"
                data-image-url="{{ product.image_url|default_if_none:'' }}"
                data-ideal-quantity="{{ product.ideal_quantity|default:'' }}"
                data-critical-quantity="{{ product.critical_quantity|default:'' }}">
                <div class="col-id">{{ product.id|default:"N/A" }}</div>
                <div class="col-nome">{{ product.name }}</div>
                <div class="col-descricao">{{ product.description|truncatewords:10 }}</div>
                <div class="col-preco">R$ {{ product.price|floatformat:2 }}</div>
                <div class="col-quantidade">{{ product.quantity|default:0 }}</div>
                <div class="col-status">
                    <span class="status-badge {% if product.is_available %}disponivel{% else %}indisponivel{% endif %}">
                        {% if product.is_available %}Disponível{% else %}Indisponível{% endif %}
                    </span>
                </div>
                <div class="col-acoes">
                    <button class="btn-editar" onclick="editarProduto('{{ product.id }}')">Editar</button>
                    <button class="btn-excluir" onclick="excluirProduto('{{ product.id }}', '{{ product.name }}')">Excluir</button>
                    <button class="btn-status {% if product.is_available %}desativar{% else %}ativar{% endif %}"
                            onclick="toggleStatus('{{ product.id }}', this, {% if product.is_available %}true{% else %}false{% endif %})">
                        {% if product.is_available %}Desativar{% else %}Ativar{% endif %}
                    </button>
                </div>
            </div>
            {% empty %}
             <div class="linha-vazia">Nenhum produto cadastrado. Clique em "Cadastrar" para começar.</div>
            {% endfor %}
        </div>
    </div>

    <div id="modal-produto" class="modal">
        <div class="modal-conteudo">
            <div class="modal-cabecalho">
                <h2 id="modal-titulo">Adicionar Produto</h2>
                <span class="fechar-modal" onclick="fecharModal()">&times;</span>
            </div>

            <form id="form-produto" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" id="produto-id" name="produto_id">
                <input type="hidden" id="modo-edicao" name="modo_edicao" value="false">

                <div class="modal-corpo">
                    <div class="coluna-esquerda">
                        <div class="upload-imagem">
                            <div class="imagem-preview" id="imagem-preview" onclick="document.getElementById('imagem-input').click()">
                                <div class="preview-spinner" style="display: none;"></div>
                                <img src="" alt="Preview" id="preview-img" style="display: none;">
                                <div id="placeholder-text">+ Clique para adicionar foto</div>
                            </div>
                            <input type="file" id="imagem-input" name="image" accept="image/*" style="display: none;">
                            <button type="button" class="btn-upload" onclick="document.getElementById('imagem-input').click()">
                                Selecionar imagem
                            </button>
                        </div>
                    </div>

                    <div class="coluna-direita">
                        <div class="form-group form-group-full-width">
                            <label for="nome">Nome do Produto *</label>
                            <input type="text" id="nome" name="name" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="categoria">Categoria *</label>
                                <select id="categoria" name="category" required>
                                    <option value="" disabled selected>Selecione</option>
                                    {% if categorias %}
                                        {% for categoria in categorias %}
                                            <option value="{{ categoria }}">{{ categoria }}</option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="" disabled>Erro ao carregar</option>
                                    {% endif %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="preco">Preço (R$) *</label>
                                <input type="number" id="preco" name="price" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="quantidade">Quantidade *</label>
                                <input type="number" id="quantidade" name="quantity" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="status">Status</label>
                                <select id="status" name="is_available">
                                    <option value="true">Disponível</option>
                                    <option value="false">Indisponível</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="quantidade_ideal" title="Quantidade ideal para manter em estoque...">
                                    Qtd. Ideal Estoque <span class="help-icon">(?)</span>
                                </label>
                                <input type="number" id="quantidade_ideal" name="ideal_quantity" min="0" placeholder="Opcional">
                            </div>
                            <div class="form-group">
                                <label for="quantidade_critica" title="Quantidade crítica de estoque...">
                                    Qtd. Crítica Estoque <span class="help-icon">(?)</span>
                                </label>
                                <input type="number" id="quantidade_critica" name="critical_quantity" min="0" placeholder="Opcional">
                            </div>
                        </div>
                        <div class="form-group form-group-full-width">
                            <label for="descricao">Descrição</label>
                            <textarea id="descricao" name="description" rows="4" placeholder="Descreva o produto..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-rodape">
                    <button type="button" class="btn-cancelar" onclick="fecharModal()">Cancelar</button>
                    <button type="submit" class="btn-salvar" id="btn-salvar-produto">
                        <span id="btn-text">Salvar Produto</span>
                         <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-editor-imagem" class="modal">
        <div class="modal-conteudo" style="max-width: 800px;">
            <div class="modal-cabecalho">
                <h2>Editar Imagem</h2>
                <span class="fechar-modal" onclick="fecharEditorImagem()">&times;</span>
            </div>

            <div class="editor-imagem-corpo">
                <div class="editor-toolbar">
                    <button type="button" class="btn-editor" onclick="rotateImage()" title="Rotacionar 90°">↻ Rotacionar</button>
                    <button type="button" class="btn-editor" onclick="zoomIn()" title="Zoom In">+ Zoom In</button>
                    <button type="button" class="btn-editor" onclick="zoomOut()" title="Zoom Out">- Zoom Out</button>
                    <button type="button" class="btn-editor" onclick="resetEditor()" title="Resetar">⟲ Resetar</button>
                </div>

                <div class="editor-container">
                    <div class="image-crop-container">
                        <img id="editor-image" src="" alt="Imagem para editar">
                    </div>
                </div>

                <div class="editor-preview">
                    <h4>Preview:</h4>
                    <div class="preview-container">
                        <img id="preview-edited" src="" alt="Preview">
                    </div>
                </div>
            </div>

            <div class="modal-rodape">
                <button type="button" class="btn-cancelar" onclick="fecharEditorImagem()">Cancelar</button>
                <button type="button" class="btn-salvar" onclick="salvarImagemEditada()">Aplicar Edições</button>
            </div>
        </div>
    </div>

    <div id="modal-confirmacao" class="modal">
        <div class="modal-conteudo confirmacao"> 
            <div class="modal-cabecalho">
                 <h2 id="confirmacao-titulo">Confirmar exclusão</h2>
                 <span class="fechar-modal" onclick="fecharConfirmacao()">&times;</span>
            </div>
             <div class="modal-corpo">
                <p id="confirmacao-mensagem">Tem certeza que deseja excluir este produto?</p>
             </div>
             <div class="modal-rodape botoes-confirmacao">
                <button class="btn-cancelar" onclick="fecharConfirmacao()">Cancelar</button>
                <button class="btn-confirmar" id="btn-confirmar-acao">Confirmar</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script src="{% static 'dashboard/js/produtos.js' %}"></script>
{% endblock %}
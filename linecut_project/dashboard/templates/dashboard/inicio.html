{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}LineCut - Dashboard Início{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{% static 'dashboard/css/inicio.css' %}">
{% endblock %}

{% block content %}
    <header class="cabecalho">
        <h1>Bem-vindo!</h1>
        <p>Olá, {{ request.session.user_profile.nome_lanchonete|default:"Usuário" }}! Aqui está o resumo do seu dia até agora</p>
    </header>

    <div class="info-cards">
        <div class="info-card dados-lanchonete">
            <div class="lanchonete-imagem">
                {# Utiliza a URL real da session, com fallback para a imagem default #}
                <img src="{{ request.session.user_profile.image_url|default:'/static/dashboard/images/perfil_default.png' }}" alt="Logo Lanchonete">
            </div>
            <div class="lanchonete-info">
                <h2>{{ request.session.user_profile.nome_lanchonete|default:"Nome Lanchonete" }}</h2>
                <p class="categoria">{{ request.session.user_profile.description|default:"Categoria" }}</p>
                <p class="endereco">{{ request.session.user_profile.polo|default:"Endereço" }}</p>
            </div>
            <div class="editar-icon" onclick="window.location.href='{% url 'dashboard:configuracoes' %}'">
                <img src="{% static 'dashboard/images/icone_edicao.png' %}" alt="Editar">
            </div>
        </div>

        <div class="info-card horario-funcionamento">
            <h3>Horário de funcionamento</h3>
            <div class="dias-semana">
                {% for dia in horario_display %}
                <div class="dia-item">
                    <p class="dia-nome">{{ dia.dia_nome }}</p>
                    <div class="horario-box">
                        <span class="{% if dia.fechado %}fechado{% endif %}">{{ dia.horario_str }}</span>
                    </div>
                </div>
                {% empty %}
                <div style="flex: 1; text-align: center; color: var(--cinza-escuro); font-size: 14px;">Horário não configurado.</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <section class="desempenho-diario">
        <h2>Desempenho diário</h2>
        <div class="metricas-container">
            <div class="metrica">
                <h3>Pedidos recebidos hoje</h3>
                <p class="valor">{{ pedidos_hoje }}</p>
            </div>
            <div class="separador"></div>
            <div class="metrica">
                <h3>Total em vendas</h3>
                <p class="valor">{{ total_vendas }}</p>
            </div>
            <div class="separador"></div>
            <div class="metrica">
                <h3>Avaliação média</h3>
                <div class="avaliacao-container">
                    <img src="{% static 'dashboard/images/icone_estrela_hd.png' %}" alt="Avaliação" class="estrela-icon-hd">
                    <p class="valor">{{ avaliacao_media }}</p>
                </div>
                <p class="total-avaliacoes">({{ total_avaliacoes }} avaliações)</p>
            </div>
        </div>
    </section>

    <section class="ultimos-pedidos">
        <h2>Últimos pedidos realizados</h2>
        <div class="tabela-pedidos">
            <div class="cabecalho-tabela">
                <span class="col-status">Status</span>
                <span class="col-numero">Número pedido</span>
                <span class="col-valor">Valor</span>
                <span class="col-data">Data</span>
                <span class="col-acao">Detalhes</span>
            </div>
            {% for pedido in ultimos_pedidos %}
            <div class="linha-pedido">
                <div class="col-status">
                    <div class="status-indicator {{ pedido.dot_class }}"></div>
                    <span>{{ pedido.status_display }}</span>
                </div>
                <div class="col-numero">#{{ pedido.id }}</div>
                <div class="col-valor">R$ {{ pedido.preco_total|floatformat:2|default:'0,00' }}</div>
                <div class="col-data">{{ pedido.data_criacao_display }}</div>
                <div class="col-acao">
                    {# O link 'Ver detalhes' deve levar o usuário para a página de pedidos, sem necessidade de lógica de JS mais complexa aqui #}
                    <a href="{% url 'dashboard:pedidos' %}" class="ver-detalhes">Ver pedidos</a> 
                </div>
            </div>
            {% empty %}
             <div class="linha-pedido" style="text-align: center; justify-content: center; color: var(--cinza-escuro); font-style: italic;">
                 Nenhum pedido recente.
            </div>
            {% endfor %}
        </div>

        <button class="btn-ver-pedidos" onclick="window.location.href='{% url 'dashboard:pedidos' %}'">Ver Todos os Pedidos</button>
    </section>

    <div id="planoModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Alteração de Plano</h2>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-icon">
                    <img src="{% static 'dashboard/images/icone_info.png' %}" alt="Informação">
                </div>
                <div class="modal-message">
                    <h3 id="modalTitle">Seu plano foi atualizado</h3>
                    <p id="modalMessage">Seu período trial expirou. Seu plano foi alterado para Basic. Agora há uma taxa de 7% por venda.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="modalConfirm" class="modal-btn confirm">Entendi</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script src="{% static 'dashboard/js/inicio.js' %}"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof checkTrialExpiration === 'function') {
            checkTrialExpiration();
        } else {
            console.error("Função checkTrialExpiration não encontrada em inicio.js");
        }
    });
    </script>
{% endblock %}
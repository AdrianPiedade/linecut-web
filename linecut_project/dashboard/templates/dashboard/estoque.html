{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}LineCut - Estoque{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{% static 'dashboard/css/estoque.css' %}">
{% endblock %}

{% block content %}
    <header class="cabecalho-estoque">
        <div class="titulos">
            <h1 class="titulo-ativo">Estoque</h1>
        </div>
    </header>

    <div class="filtros">
        <div class="filtro-group">
            <label>Buscar produto</label>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Digite o nome do produto...">
            </div>
        </div>
        <div class="filtro-group">
            <label>Categoria</label>
            <select id="categoria-filter">
                <option value="">Todas as categorias</option>
                <option value="Salgados">Salgados</option>
                <option value="Lanches">Lanches</option>
                <option value="Bebidas">Bebidas</option>
                <option value="Sobremesas">Sobremesas</option>
                <option value="Doces">Doces</option>
                <option value="Acompanhamentos">Acompanhamentos</option>
                <option value="Saudáveis">Saudáveis</option>
                <option value="Laticínios">Laticínios</option>
                <option value="Ingredientes">Ingredientes</option>
            </select>
        </div>
        <div class="filtro-group">
            <label>Status estoque</label>
            <select id="status-estoque-filter">
                <option value="">Todos</option>
                <option value="suficiente">Suficiente</option>
                <option value="baixo">Baixo</option>
                <option value="critico">Crítico</option>
            </select>
        </div>
    </div>

    <div class="tabela-container">
        <div class="cabecalho-tabela">
            <span class="col-id">ID</span>
            <span class="col-nome">Produto</span>
            <span class="col-descricao">Descrição</span>
            <span class="col-preco">Preço</span>
            <span class="col-quantidade">Qtd. Atual</span>
            <span class="col-status">Status Estoque</span>
            <span class="col-acoes">Ações</span>
        </div>

        <div class="corpo-tabela" id="estoque-lista">
            {% for product in products %}
            <div class="linha-estoque"
                data-product-id="{{ product.id|default:'N/A' }}"
                data-category="{{ product.category }}"
                data-status-estoque="{% if product.critical_quantity and product.quantity <= product.critical_quantity %}critico{% elif product.ideal_quantity and product.quantity <= product.ideal_quantity %}baixo{% else %}suficiente{% endif %}"
                data-quantidade="{{ product.quantity|default:0 }}"
                data-quantidade-ideal="{{ product.ideal_quantity|default:0 }}"
                data-quantidade-critica="{{ product.critical_quantity|default:0 }}">
                <div class="col-id">{{ product.id|default:"N/A" }}</div>
                <div class="col-nome">{{ product.name }}</div>
                <div class="col-descricao">{{ product.description|truncatewords:10 }}</div>
                <div class="col-preco">R$ {{ product.price|floatformat:2 }}</div>
                <div class="col-quantidade">{{ product.quantity|default:0 }}</div>
                <div class="col-status">
                    <span class="status-badge {% if product.critical_quantity and product.quantity <= product.critical_quantity %}critico{% elif product.ideal_quantity and product.quantity <= product.ideal_quantity %}baixo{% else %}suficiente{% endif %}">
                        {% if product.critical_quantity and product.quantity <= product.critical_quantity %}Crítico
                        {% elif product.ideal_quantity and product.quantity <= product.ideal_quantity %}Baixo
                        {% else %}Suficiente
                        {% endif %}
                    </span>
                </div>
                <div class="col-acoes">
                    <button class="btn-editar" onclick="editarEstoque('{{ product.id }}')">
                        Editar
                    </button>
                </div>
            </div>
            {% empty %}
             <div class="linha-vazia">Nenhum produto encontrado para gerenciar o estoque. Cadastre produtos primeiro.</div>
            {% endfor %}
        </div>
    </div>

    <div class="legenda-status">
        <div class="status-item"><div class="indicador-status suficiente"></div><span>Suficiente</span></div>
        <div class="status-item"><div class="indicador-status baixo"></div><span>Baixo</span></div>
        <div class="status-item"><div class="indicador-status critico"></div><span>Crítico</span></div>
    </div>

    <div id="modal-estoque" class="modal">
        <div class="modal-conteudo modal-estoque">
            <div class="modal-cabecalho">
                <h2 id="modal-titulo">Editar Estoque</h2>
                <span class="fechar-modal" onclick="fecharModalEstoque()">&times;</span>
            </div>

            <form id="form-estoque">
                {% csrf_token %}
                <input type="hidden" id="produto-id" name="produto_id">

                <div class="modal-corpo">
                    <div class="info-produto">
                        <h3 id="nome-produto">Nome do Produto</h3>
                        <p id="categoria-produto">Categoria</p>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="quantidade-atual">Quantidade Atual *</label>
                            <input type="number" id="quantidade-atual" name="quantity" min="0" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="quantidade-ideal" title="Quantidade ideal para manter em estoque...">
                                Quantidade Ideal <span class="help-icon">(?)</span>
                            </label>
                            <input type="number" id="quantidade-ideal" name="ideal_quantity" min="0" placeholder="Opcional">
                        </div>
                        <div class="form-group">
                            <label for="quantidade-critica" title="Quantidade crítica de estoque...">
                                Quantidade Crítica <span class="help-icon">(?)</span>
                            </label>
                            <input type="number" id="quantidade-critica" name="critical_quantity" min="0" placeholder="Opcional">
                        </div>
                    </div>

                    <div class="info-status">
                        <h4>Status Atual do Estoque:</h4>
                        <div class="status-preview">
                            <span class="status-badge" id="status-preview">Suficiente</span>
                        </div>
                    </div>
                </div>

                <div class="modal-rodape">
                    <button type="button" class="btn-cancelar" onclick="fecharModalEstoque()">Cancelar</button>
                    <button type="submit" class="btn-salvar" id="btn-salvar-estoque">
                        <span id="btn-text">Salvar Alterações</span>
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-confirmacao" class="modal">
        <div class="modal-conteudo confirmacao">
             <div class="modal-cabecalho">
                 <h2 id="confirmacao-titulo">Confirmar</h2>
                 <span class="fechar-modal" onclick="fecharConfirmacao()">&times;</span>
            </div>
             <div class="modal-corpo">
                <p id="confirmacao-mensagem">Tem certeza?</p>
             </div>
            <div class="modal-rodape botoes-confirmacao">
                <button class="btn-cancelar" onclick="fecharConfirmacao()">Cancelar</button>
                <button class="btn-confirmar" id="btn-confirmar-acao">Confirmar</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script src="{% static 'dashboard/js/estoque.js' %}"></script>
{% endblock %}